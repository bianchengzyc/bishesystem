import{u as re,h as I,r as s,i as se,f as ie,c as ue,b as c,d as l,j as de,w as o,e as n,k as pe,l as ce,E as i,o as D,g as p,m as me,s as fe,n as ge}from"./index-C3FQOh13.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ve={class:"image-list-container"},we={class:"header"},he={class:"dialog-footer"},ye={class:"filter-section"},be={class:"pagination"},Ve={class:"export-section"},ke={__name:"ImageList",setup(Ce){const S=ie(),$=re(),_=I(()=>$.token),b=s(!1),E=s([]),z=s([]),v=s(""),w=s(""),m=s(1),V=s(10),B=s(0),h=s([]),f=s(!1),j=s(),r=s({capture_date:new Date,region:"",resolution:1,crs:"EPSG:32632"}),y=s(null),F=I(()=>{let t=[...E.value];return v.value&&(t=t.filter(e=>e.file_name.toLowerCase().includes(v.value.toLowerCase()))),w.value==="annotated"?t=t.filter(e=>e.annotation_count>0):w.value==="unannotated"&&(t=t.filter(e=>e.annotation_count===0)),t}),k=async()=>{b.value=!0;try{const t=await fetch("/api/images",{headers:{Authorization:`Bearer ${_.value}`}});if(t.ok){const e=await t.json();E.value=e.images,B.value=e.total}else throw new Error("获取图像列表失败")}catch(t){console.error("Error fetching images:",t),i.error("获取图像列表失败")}finally{b.value=!1}},L=()=>{r.value={capture_date:new Date,region:"",resolution:1,crs:"EPSG:32632"},z.value=[],y.value=null,f.value=!0},A=(t,e)=>{if(!t.raw.type.startsWith("image/"))return i.error("只能上传图片文件"),!1;if(t.raw.size/1024/1024>=200)return i.error("上传图片大小不能超过200MB"),!1;y.value=t.raw},q=async()=>{if(!y.value){i.error("请先选择要上传的图像");return}const t=new FormData;t.append("image",y.value),t.append("capture_date",r.value.capture_date),t.append("region",r.value.region),t.append("resolution",r.value.resolution),t.append("crs",r.value.crs);try{const e=await fetch("/api/images/upload",{method:"POST",headers:{Authorization:`Bearer ${_.value}`},body:t}),u=await e.json();e.ok&&u.success?(i.success("上传成功"),f.value=!1,k()):i.error(u.message||"上传失败")}catch(e){console.error("Error uploading image:",e),i.error("上传失败，请重试")}},M=()=>{m.value=1},P=()=>{m.value=1},T=t=>{S.push({path:`/annotations/${t.image_id}`,query:{image:JSON.stringify(t)}})},N=async t=>{try{if(await ge.confirm("确定要删除这张图像吗？此操作不可恢复。","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await fetch(`/api/images/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${_.value}`}})).ok)i.success("删除成功"),k();else throw new Error("删除失败")}catch(e){e!=="cancel"&&(console.error("Error deleting image:",e),i.error("删除失败"))}},G=t=>{h.value=t},R=()=>{if(h.value.length===0){i.warning("请选择要导出的图像");return}const t=h.value.map(e=>e.image_id).join(",");window.open(`/api/export/yolo?image_ids=${t}`,"_blank"),i.success("开始导出数据")},O=()=>{window.open("/api/export/yolo","_blank"),i.success("开始导出全部数据")},J=t=>{V.value=t,m.value=1},Q=t=>{m.value=t},U=t=>t?`/uploads/images/${t.split("\\").pop()||t.split("/").pop()}`:"";return se(()=>{if(!_.value){S.push("/login");return}k()}),(t,e)=>{const u=n("el-button"),W=n("el-upload"),g=n("el-form-item"),H=n("el-date-picker"),C=n("el-input"),K=n("el-input-number"),X=n("el-form"),Y=n("el-dialog"),Z=n("el-icon"),x=n("el-option"),ee=n("el-select"),d=n("el-table-column"),te=n("el-image"),le=n("el-table"),ae=n("el-pagination"),oe=pe("loading");return D(),ue("div",ve,[c("div",we,[e[11]||(e[11]=c("h2",null,"图像数据管理",-1)),l(u,{type:"primary",icon:"Plus",onClick:L},{default:o(()=>[...e[10]||(e[10]=[p("上传图像",-1)])]),_:1})]),l(Y,{modelValue:f.value,"onUpdate:modelValue":e[5]||(e[5]=a=>f.value=a),title:"上传图像",width:"600px"},{footer:o(()=>[c("div",he,[l(u,{onClick:e[4]||(e[4]=a=>f.value=!1)},{default:o(()=>[...e[14]||(e[14]=[p("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:q},{default:o(()=>[...e[15]||(e[15]=[p("确定上传",-1)])]),_:1})])]),default:o(()=>[l(X,{ref_key:"uploadFormRef",ref:j,model:r.value,"label-width":"120px"},{default:o(()=>[l(g,{label:"选择图像",required:""},{default:o(()=>[l(W,{class:"image-uploader","file-list":z.value,"auto-upload":!1,"on-change":A,accept:".jpg,.png,.tif",limit:1},{tip:o(()=>[...e[13]||(e[13]=[c("div",{class:"el-upload__tip"}," 只能上传jpg/png/tif文件，且不超过200MB ",-1)])]),default:o(()=>[l(u,{type:"primary"},{default:o(()=>[...e[12]||(e[12]=[p("点击选择图像",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1}),l(g,{label:"拍摄日期",prop:"capture_date",required:""},{default:o(()=>[l(H,{modelValue:r.value.capture_date,"onUpdate:modelValue":e[0]||(e[0]=a=>r.value.capture_date=a),type:"datetime",placeholder:"选择拍摄日期时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(g,{label:"区域",prop:"region",required:""},{default:o(()=>[l(C,{modelValue:r.value.region,"onUpdate:modelValue":e[1]||(e[1]=a=>r.value.region=a),placeholder:"请输入图像区域",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(g,{label:"分辨率",prop:"resolution",required:""},{default:o(()=>[l(K,{modelValue:r.value.resolution,"onUpdate:modelValue":e[2]||(e[2]=a=>r.value.resolution=a),min:.1,max:100,step:.1,placeholder:"请输入图像分辨率",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(g,{label:"坐标参考系统",prop:"crs"},{default:o(()=>[l(C,{modelValue:r.value.crs,"onUpdate:modelValue":e[3]||(e[3]=a=>r.value.crs=a),placeholder:"请输入坐标参考系统（如EPSG:32632）",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),c("div",ye,[l(C,{modelValue:v.value,"onUpdate:modelValue":e[6]||(e[6]=a=>v.value=a),placeholder:"搜索图像名称",clearable:"",class:"search-input",onInput:M},{prefix:o(()=>[l(Z,null,{default:o(()=>[l(me(fe))]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=a=>w.value=a),placeholder:"筛选状态",class:"filter-select",onChange:P},{default:o(()=>[l(x,{label:"全部",value:""}),l(x,{label:"已标注",value:"annotated"}),l(x,{label:"未标注",value:"unannotated"})]),_:1},8,["modelValue"])]),de((D(),ce(le,{data:F.value,style:{width:"100%"},onSelectionChange:G},{default:o(()=>[l(d,{type:"selection",width:"55"}),l(d,{prop:"image_id",label:"ID",width:"80"}),l(d,{prop:"file_name",label:"图像名称","min-width":"200"}),l(d,{label:"缩略图",width:"120"},{default:o(a=>[l(te,{src:U(a.row.file_path),fit:"cover","preview-src-list":[U(a.row.file_path)],style:{width:"80px",height:"60px",cursor:"pointer"}},null,8,["src","preview-src-list"])]),_:1}),l(d,{prop:"upload_time",label:"上传时间",width:"180"}),l(d,{prop:"image_width",label:"宽度",width:"80"}),l(d,{prop:"image_height",label:"高度",width:"80"}),l(d,{prop:"annotation_count",label:"标注数量",width:"100"}),l(d,{label:"操作",width:"180",fixed:"right"},{default:o(a=>[l(u,{type:"primary",size:"small",onClick:ne=>T(a.row)},{default:o(()=>[...e[16]||(e[16]=[p(" 查看标注 ",-1)])]),_:1},8,["onClick"]),l(u,{type:"warning",size:"small",onClick:ne=>N(a.row.image_id)},{default:o(()=>[...e[17]||(e[17]=[p(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[oe,b.value]]),c("div",be,[l(ae,{"current-page":m.value,"onUpdate:currentPage":e[8]||(e[8]=a=>m.value=a),"page-size":V.value,"onUpdate:pageSize":e[9]||(e[9]=a=>V.value=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:B.value,onSizeChange:J,onCurrentChange:Q},null,8,["current-page","page-size","total"])]),c("div",Ve,[l(u,{type:"success",disabled:h.value.length===0,onClick:R},{default:o(()=>[...e[18]||(e[18]=[p(" 导出选中图像数据 ",-1)])]),_:1},8,["disabled"]),l(u,{type:"success",onClick:O},{default:o(()=>[...e[19]||(e[19]=[p("导出全部数据",-1)])]),_:1})])])}}},Ee=_e(ke,[["__scopeId","data-v-f18f0fd4"]]);export{Ee as default};

import{u as K,h as D,r as c,p as Q,i as Z,f as ee,c as _,b as n,d,w as m,e as x,q as te,F as V,t as F,v as T,l as oe,E as b,o as h,g,x as R,y as i,z as ne,n as ae}from"./index-C3FQOh13.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"annotation-container"},ie={class:"header"},ue={class:"main-content"},re={class:"image-section"},ce=["src","alt"],de=["onMousedown"],ve={class:"bbox-controls"},pe=["onClick"],me={class:"info-section"},he={class:"image-info"},_e={class:"annotation-tools"},ge={class:"annotation-list"},fe={key:1,class:"annotation-items"},ye=["onClick"],we={class:"annotation-index"},xe={class:"annotation-coords"},be={__name:"AnnotationView",setup(ke){const X=ee(),E=Q(),j=K(),k=D(()=>j.token),C=c(null),M=c(null),a=c({}),u=c([]),l=c(!1),Y=c(!0),f=c(null),z=c(null),y=c({x:0,y:0}),r=c({x:0,y:0,width:0,height:0}),q=D(()=>E.params.id),O=D(()=>a.value.file_path?`/uploads/images/${a.value.file_path.split("\\").pop()||a.value.file_path.split("/").pop()}`:""),J=()=>{l.value=!l.value,l.value&&(f.value=null,z.value=null)},P=()=>{M.value&&console.log("Image loaded:",M.value.width,"x",M.value.height)},U=t=>{if(!l.value)return;l.value=!0;const e=C.value.getBoundingClientRect();y.value={x:t.clientX-e.left,y:t.clientY-e.top},r.value={...y.value,width:0,height:0}},H=t=>{if(!l.value)return;const e=C.value.getBoundingClientRect(),s=t.clientX-e.left,v=t.clientY-e.top;r.value={x:Math.min(y.value.x,s),y:Math.min(y.value.y,v),width:Math.abs(s-y.value.x),height:Math.abs(v-y.value.y)}},L=()=>{if(l.value){if(l.value=!1,r.value.width<10||r.value.height<10){b.warning("边界框太小，请重新绘制");return}u.value.push({...r.value,image_id:a.value.image_id,label_class:0}),r.value={x:0,y:0,width:0,height:0},Y.value=!0}},S=(t,e=null)=>{if(!l.value&&(f.value=t.annotation_id,z.value=t,e)){e.preventDefault();const s=C.value.getBoundingClientRect(),v=e.clientX-s.left-t.x,A=e.clientY-s.top-t.y,$=o=>{const p=o.clientX-s.left-v,w=o.clientY-s.top-A;t.x=Math.max(0,p),t.y=Math.max(0,w)},B=()=>{document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",B)};document.addEventListener("mousemove",$),document.addEventListener("mouseup",B)}},I=t=>{ae.confirm("确定要删除这个标注吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{var e;u.value.splice(t,1),f.value===((e=u[t])==null?void 0:e.annotation_id)&&(f.value=null),b.success("删除成功")}).catch(()=>{})},W=async()=>{try{const t=await fetch(`/api/annotations/${a.value.image_id}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k.value}`},body:JSON.stringify({annotations:u.value})});if(t.ok){const e=await t.json();u.value=e.annotations,b.success("标注保存成功")}else throw new Error("保存失败")}catch(t){console.error("Error saving annotations:",t),b.error("保存失败，请重试")}},G=async()=>{try{if(E.query.image)a.value=JSON.parse(E.query.image);else{const e=await fetch(`/api/images/${q.value}`,{headers:{Authorization:`Bearer ${k.value}`}});if(e.ok)a.value=await e.json();else throw new Error("获取图像数据失败")}const t=await fetch(`/api/annotations/image/${a.value.image_id}`,{headers:{Authorization:`Bearer ${k.value}`}});if(t.ok){const e=await t.json();u.value=e.annotations||[]}}catch(t){console.error("Error loading image data:",t),b.error("加载图像数据失败"),N()}},N=()=>{X.push("/images")};return Z(()=>{if(!k.value){X.push("/login");return}G()}),(t,e)=>{const s=x("el-button"),v=x("el-descriptions-item"),A=x("el-descriptions"),$=x("el-divider"),B=x("el-empty");return h(),_("div",le,[n("div",ie,[e[2]||(e[2]=n("h2",null,"图像标注",-1)),d(s,{type:"primary",onClick:W},{default:m(()=>[...e[0]||(e[0]=[g("保存标注",-1)])]),_:1}),d(s,{onClick:N},{default:m(()=>[...e[1]||(e[1]=[g("返回列表",-1)])]),_:1})]),n("div",ue,[n("div",re,[n("div",{class:"annotation-canvas",ref_key:"canvasContainer",ref:C},[n("img",{ref_key:"imageRef",ref:M,src:O.value,alt:a.value.file_name,onLoad:P,onMousedown:U,onMousemove:H,onMouseup:L,onMouseleave:L},null,40,ce),(h(!0),_(V,null,F(u.value,(o,p)=>(h(),_("div",{key:o.annotation_id||p,class:"bounding-box",style:T({left:`${o.x}px`,top:`${o.y}px`,width:`${o.width}px`,height:`${o.height}px`,border:f.value===o.annotation_id?"2px solid #409EFF":"2px solid #F56C6C",cursor:"move"}),onMousedown:R(w=>S(o,w),["stop"])},[e[3]||(e[3]=n("div",{class:"bbox-label"},"枯死云杉",-1)),n("div",ve,[n("span",{class:"bbox-delete",onClick:R(w=>I(p),["stop"])},"×",8,pe)])],44,de))),128)),l.value?(h(),_("div",{key:0,class:"bounding-box temp",style:T({left:`${r.value.x}px`,top:`${r.value.y}px`,width:`${r.value.width}px`,height:`${r.value.height}px`})},null,4)):te("",!0)],512)]),n("div",me,[n("div",he,[e[4]||(e[4]=n("h3",null,"图像信息",-1)),d(A,{column:1,border:""},{default:m(()=>[d(v,{label:"图像名称"},{default:m(()=>[g(i(a.value.file_name),1)]),_:1}),d(v,{label:"图像尺寸"},{default:m(()=>[g(i(a.value.image_width)+" × "+i(a.value.image_height)+" 像素",1)]),_:1}),d(v,{label:"上传时间"},{default:m(()=>[g(i(a.value.upload_time),1)]),_:1}),d(v,{label:"标注数量"},{default:m(()=>[g(i(u.value.length),1)]),_:1})]),_:1})]),n("div",_e,[e[6]||(e[6]=n("h3",null,"标注工具",-1)),d(s,{type:"primary",disabled:!Y.value,onClick:J},{default:m(()=>[g(i(l.value?"停止绘制":"开始绘制边界框"),1)]),_:1},8,["disabled"]),d($),n("div",ge,[e[5]||(e[5]=n("h4",null,"当前标注列表",-1)),u.value.length===0?(h(),oe(B,{key:0,description:"暂无标注"})):(h(),_("div",fe,[(h(!0),_(V,null,F(u.value,(o,p)=>(h(),_("div",{key:o.annotation_id||p,class:ne(["annotation-item",{active:f.value===o.annotation_id}]),onClick:w=>S(o)},[n("span",we,i(p+1),1),n("span",xe," X: "+i(o.x)+", Y: "+i(o.y)+", W: "+i(o.width)+", H: "+i(o.height),1),d(s,{type:"danger",size:"small",icon:"Delete",onClick:R(w=>I(p),["stop"])},null,8,["onClick"])],10,ye))),128))]))])])])])])}}},$e=se(be,[["__scopeId","data-v-202dd4f7"]]);export{$e as default};
